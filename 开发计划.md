# AI 小说写作应用开发计划

本计划基于已确定的“融合架构”方案，旨在分阶段、有步骤地完成整个应用的开发。

---

### **阶段 0：项目初始化与环境配置 (预计 0.5 天)**

此阶段的目标是搭建一个可以运行的、最基础的“应用外壳”。

1.  **创建项目根目录**：即 `AI_xiaoshuo`。
2.  **初始化前端项目**：
    *   使用 `Vite` 初始化一个 `Vue + TypeScript` 项目。
    *   目录名建议为 `app-renderer` 或 `frontend`。
3.  **集成 Electron**：
    *   在项目中添加 `Electron`、`electron-builder` 等核心依赖。
    *   创建 Electron 的主进程文件 (`main.ts`) 和预加载脚本 (`preload.ts`)。
    *   配置 `package.json` 中的启动脚本，实现通过 `npm run dev` 能同时启动 Vite 开发服务器和 Electron 应用窗口。
4.  **创建 AI 服务端目录**：
    *   在根目录下创建 `ai-server` 目录。
    *   在 `ai-server` 中，建立 Python 虚拟环境，并创建 `requirements.txt` 文件，预先加入 `fastapi`, `uvicorn`, `pydantic` 等基础依赖。

---

### **阶段 1：核心 UI 框架与布局 (预计 1-2 天)**

此阶段专注于用户可见的界面，暂时不接入任何 AI 功能。

1.  **引入 UI 组件库**：为 Vue 项目引入一个合适的组件库，例如 `Element Plus` 或 `Naive UI`，以加速开发。
2.  **搭建主界面布局**：创建应用的主体布局，例如左侧是功能导航栏，右侧是主工作区。
3.  **创建视图组件**：为需求文档中的每个核心功能（人物、大纲、章节、扩写、知识库、设置）创建空白的 Vue 视图组件。
4.  **实现视图切换**：完成基础的路由功能，允许用户在不同功能视图之间切换。

---

### **阶段 2：AI 服务端基础功能开发 (预计 2-3 天)**

此阶段独立开发 Python AI 服务，目标是让其能独立运行并提供最基础的 API。

1.  **搭建 FastAPI 服务器**：在 `ai-server` 中，编写一个基础的 FastAPI 应用。
2.  **创建健康检查接口**：实现一个 `/health` 接口，访问时返回 `{"status": "ok"}`，用于后续验证服务是否成功启动。
3.  **实现配置接口**：创建一个 `/config` 接口，允许应用端设置知识库的文件夹路径。
4.  **开发 RAG 核心逻辑 (占位)**：
    *   编写 RAG 服务的核心类 `RAGService`。
    *   实现**首次索引**的逻辑：读取文件、分块、调用（模拟的）Embedding 模型、存入（内存级）向量数据库。
    *   实现一个占位的 `/rag_generate` 接口，它能接收请求，但暂时只返回一个固定的模拟回答。

---

### **阶段 3：前后端集成与生命周期管理 (预计 1 天)**

此阶段的目标是打通 Electron 和 Python 服务，实现“融合方案”的核心机制。

1.  **实现服务生命周期管理**：
    *   在 Electron 的 `main.ts` 中，编写逻辑：在应用启动时，通过 `child_process` 启动 `ai-server` 的 Python 进程。
    *   在应用退出时，确保关联的 Python 进程也被一同终止。
2.  **创建 API 客户端**：在 Vue 应用中，创建一个 API 客户端模块，用于统一调用本地的 Python API (例如 `http://localhost:8000`)。
3.  **联调测试**：在 Vue 应用的某个界面上，尝试调用 Python 服务的 `/health` 接口，并根据返回结果显示“AI 服务状态：已连接 / 未连接”。

---

### **阶段 4：核心 AI 功能端到端实现 (预计 3-5 天)**

此阶段是工作量最大的部分，我们将逐一实现每个 AI 功能。

1.  **知识库管理界面**：实现 UI，允许用户选择文件夹，并调用后端的配置和索引接口。
2.  **人物/大纲/章节生成**：为这三个功能创建对应的 UI 输入界面，并联调后端的生成接口。
3.  **剧情扩写器**：
    *   在 UI 上，构建用于展示“分层上下文”的调试视图（可选，但建议）。
    *   完整实现调用 `/rag_generate` 接口的逻辑，传递所有必需的上下文信息。
    *   在编辑器中展示 AI 返回的文本流或完整文本。
4.  **完善 RAG 流程**：替换阶段 2 中的模拟实现，接入真实可用的 Embedding 模型和 LLM API。

---

### **阶段 5：打包与分发 (预计 1-2 天)**

此阶段的目标是生成一个可以给他人安装使用的独立应用。

1.  **打包 Python 服务**：使用 `PyInstaller` 将 `ai-server` 完整打包成一个可执行文件。
2.  **配置 Electron Builder**：
    *   修改 `electron-builder` 的配置，使其在打包主应用时，能将上一步生成的 Python 可执行文件包含到最终的安装包资源中。
    *   确保 `main.ts` 中的服务启动逻辑能正确找到这个打包后的可执行文件路径。
3.  **构建与测试**：在 Windows 和 macOS 上分别构建应用，并找一台干净的电脑测试安装和运行是否正常。

---

### **阶段 6：优化与完善 (持续)**

1.  **设置界面**：实现 API Key 的输入和本地安全存储。
2.  **错误处理**：为所有 API 调用和后台进程管理添加稳健的错误处理和用户提示。
3.  **导出功能**：实现将小说内容导出为 TXT, DOCX 等格式。
4.  **性能优化**：根据使用情况，优化 RAG 检索速度、UI 响应等。
